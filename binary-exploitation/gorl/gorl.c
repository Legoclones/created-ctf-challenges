#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>

__attribute__((constructor)) void flush_buf() {
    setbuf(stdin, NULL);
    setbuf(stdout, NULL);
    setbuf(stderr, NULL);
}


int main(int argc, char* argv[]) {
    // create RWE segment to store code
    void* code = mmap(0, 0x1000, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);

    // read shellcode
    char buf[0x20];
    printf("Gorlcode> ");

    int r = read(0, buf, 0x20); // read does not terminate on null bytes or newlines
    if (r <= 0) {
        printf("read error\n");
        return 1;
    }


    // RUN CHECKS ON SHELLCODE
    if (buf[4] != -112) {
        printf("bad");
        return 1;
    }


    // copy shellcode to RWE segment
    memcpy(code, buf, r);

    // execute shellcode
    ((void (*)())code)();

    return 0;
}